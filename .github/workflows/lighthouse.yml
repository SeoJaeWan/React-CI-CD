name: Lighthouse CI

on:
  pull_request_target:
    branches: [develop]

jobs:
  lhci:
    name: "Lighthouse Test"
    runs-on: "ubuntu-latest"

    strategy:
      matrix:
        node-version: ["18.x"]

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Node.js ${{ matrix.node-version }} & Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{matrix.node-version}}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Build
        run:
          yarn build

          # Desktop ì„¤ì •ìœ¼ë¡œ Lighthouse ì¸¡ì •
      - name: Run Lighthouse CI for Desktop
        # secretsì— ì €ì¥í•œ LHCI_GITHUB_APP_TOKEN ê°’ ì‚¬ìš©
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

        # Lighthouse CIë¥¼ ì „ì—­ìœ¼ë¡œ ì„¤ì¹˜
        # lighthouserc-desktop.js ì„¤ì • íŒŒì¼ì— ë”°ë¼ Lighthouse ë°ì´í„° ìˆ˜ì§‘
        # lighthouserc-desktop.js ì„¤ì • íŒŒì¼ì— ë”°ë¼ ìˆ˜ì§‘ëœ ë°ì´í„° ì—…ë¡œë“œ
        # ì‹¤íŒ¨ ì‹œ 'Fail to Run Lighthouse CI ğŸ’¦' ì¶œë ¥
        run: |
          npm install -g @lhci/cli
          lhci collect --config=lighthouserc-desktop.js || echo 'Fail to Run Lighthouse CI ğŸ’¦'
          lhci upload --config=lighthouserc-desktop.js || echo 'Fail to Run Lighthouse CI ğŸ’¦'

      # Mobile ì„¤ì •ìœ¼ë¡œ Lighthouse ì¸¡ì •
      - name: Run Lighthouse CI for Mobile
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

        # lighthouserc-mobile.js ì„¤ì • íŒŒì¼ì— ë”°ë¼ Lighthouse ë°ì´í„° ìˆ˜ì§‘
        # lighthouserc-mobile.js ì„¤ì • íŒŒì¼ì— ë”°ë¼ ìˆ˜ì§‘ëœ ë°ì´í„° ì—…ë¡œë“œ
        # ì‹¤íŒ¨ ì‹œ 'Fail to Run Lighthouse CI ğŸ’¦' ì¶œë ¥
        run: |
          lhci collect --config=lighthouserc-mobile.js || echo 'Fail to Run Lighthouse CI ğŸ’¦'
          lhci upload --config=lighthouserc-mobile.js || echo 'Fail to Run Lighthouse CI ğŸ’¦'

          # Lighthouse ê²°ê³¼ë¥¼ PR Commentì— ì‘ì„±í•  í˜•ì‹ëŒ€ë¡œ í¬ë§·íŒ…

    #   - name: Format lighthouse score
    #     id: format_lighthouse_score
    #     uses: actions/github-script@v7
    #     with:
    #       script: |
    #         // Lighthouse ì¸¡ì • ê²°ê³¼ íŒŒì¼ì„ ì½ì–´ì˜¤ê¸° ìœ„í•´ 'fs' import
    #         const fs = require('fs');
    #         const { getLhciPageNameFromUrl, LHCI_GREEN_MIN_SCORE, LHCI_ORANGE_MIN_SCORE, LHCI_RED_MIN_SCORE } = require('./src/configs/lighthouse/Lighthouse.js');

    #         // ì ìˆ˜ë¥¼ ë°›ì•„ì„œ í•´ë‹¹ ì ìˆ˜ì˜ ìƒ‰ìƒì„ ë¦¬í„´í•´ì£¼ëŠ” í•¨ìˆ˜
    #         const getColor = (score) => {
    #           if (score >= LHCI_GREEN_MIN_SCORE) return 'ğŸŸ¢';
    #           else if (score >= LHCI_ORANGE_MIN_SCORE) return 'ğŸŸ ';
    #           return 'ğŸ”´';
    #         }

    #         // ì ìˆ˜ë¥¼ ë°›ì•„ì„œ ìƒ‰ìƒ + ì ìˆ˜ë¥¼ ë¦¬í„´í•´ì£¼ëŠ” í•¨ìˆ˜ë“¤
    #         // Performance, Accessibility, Best Practices, SEO, PWAì— ì ìš©ë¨
    #         const getAuditColorAndScore = (score) => getColor(score) + score;

    #         // Performance í•˜ìœ„ ì§€í‘œì¸ FCP, LCP, Speed Index, TBT, CLSì— ì ìš©ë¨
    #         const getPerformanceMetricColorAndScore = (category) => getColor(category.score * 100) + category.displayValue;

    #         // ì ìˆ˜ëŠ” 0-1ì˜ ìˆ«ìë¡œ í‘œí˜„ë˜ê¸° ë•Œë¬¸ì— 100ì„ ê³±í•´ì£¼ëŠ” í•¨ìˆ˜ í•„ìš”
    #         const formatResult = (res) => Math.round(res * 100);

    #         // Lighthouse ê²°ê³¼ê°€ ì €ì¥ëœ íŒŒì¼ì—ì„œ ë‚´ìš©ì„ ì½ì–´ì˜´
    #         // pathëŠ” '{Github Actions ëŸ¬ë„ˆì˜ ê¸°ë³¸ ë””ë ‰í† ë¦¬}/{GitHub Actionsê°€ í´ë¡ í•œ ë ˆí¬ì§€í† ë¦¬ê°€ ìœ„ì¹˜í•œ ê²½ë¡œ}/{GitHub Actions ì›Œí¬í”Œë¡œìš°ì—ì„œ ì ‘ê·¼í•˜ë ¤ëŠ” ì‹¤ì œ íŒŒì¼ ê²½ë¡œ}'
    #         const desktopResults = JSON.parse(fs.readFileSync(''));
    #         const mobileResults = JSON.parse(fs.readFileSync(''));

    #         // Lighthouseë¥¼ ì¸¡ì •í•œ ì‹œê°„ (Google Spreadsheet ê¸°ë¡ ìš©ë„)
    #         const monitoringTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

    #         // PR Commentì— ì‘ì„±ë  ìƒ‰ìƒë³„ ì ìˆ˜ ê¸°ì¤€
    #         const scoreDescription = `> ğŸŸ¢: ${LHCI_GREEN_MIN_SCORE} - 100` + ' / ' + `ğŸŸ : ${LHCI_ORANGE_MIN_SCORE} - ${LHCI_GREEN_MIN_SCORE - 1}` + ' / ' + `ğŸ”´: ${LHCI_RED_MIN_SCORE} - ${LHCI_ORANGE_MIN_SCORE - 1}`;

    #         // PR Commentì— ì‘ì„±ë  comments ë³€ìˆ˜
    #         let comments = '';

    #         // commentsì— Comment ì œëª©ê³¼ ì ìˆ˜ ê¸°ì¤€ ì¶”ê°€
    #         comments += `### Lighthouse report âœ¨\n`;
    #         comments += `${scoreDescription}\n\n`;

    #         // Google SpreadSheetì— ê¸°ë¡ë  scores ê°ì²´
    #         const scores = { desktop: {}, mobile: {} };
